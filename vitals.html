<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CareConnect | Enter Vitals</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
/* CSS styles remain exactly the same */
:root{ --blue-main:#0a73ff; --blue-soft:#eaf4ff; --white:#ffffff; --text-dark:#2b2b2b; --text-light:#6a6a6a; }
*{ box-sizing:border-box; font-family:'Poppins',sans-serif; }
body{ margin:0; background:var(--blue-soft); min-height:100vh; }
.header{ background:var(--white); padding:18px 30px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 8px 20px rgba(74,144,226,0.15); }
.logo{ display:flex; align-items:center; }
.logo-icon{ width:42px; height:42px; background:var(--blue-main); border-radius:12px; display:flex; align-items:center; justify-content:center; margin-right:12px; }
.logo-icon i{ color:white; font-size:20px; }
.logo-text{ font-size:22px; font-weight:600; color:var(--text-dark); }
.back-btn{ color:var(--blue-main); font-size:14px; text-decoration:none; display:flex; align-items:center; gap:8px; }
.container{ max-width:1000px; margin:auto; padding:30px; }
h1{ color:var(--blue-main); margin-bottom:5px; }
.subtitle{ color:var(--text-light); font-size:14px; margin-bottom:25px; }
.card{ background:var(--white); border-radius:22px; padding:26px; box-shadow:0 20px 40px rgba(74,144,226,0.25); }
.form-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:20px; margin-top:20px; }
.input-box{ padding:18px; border-radius:18px; }
.input-box label{ font-size:13px; font-weight:600; margin-bottom:8px; display:block; }
.input-box input{ width:100%; padding:12px; border:none; border-radius:14px; outline:none; font-size:14px; }
.dual{ display:flex; gap:10px; } .dual input{flex:1}
.bp{background:#e8f1ff} .sugar{background:#e8fff4} .temp{background:#fff3e6} .spo2{background:#f1e9ff} .hr{background:#ffeef1}
.submit-area{ margin-top:28px; display:flex; justify-content:flex-end; }
.btn{ background:var(--blue-main); color:white; border:none; padding:14px 22px; border-radius:16px; font-size:15px; cursor:pointer; }
.note{ margin-top:18px; font-size:12px; color:var(--text-light); }
</style>
</head>

<body>

<div class="header">
  <div class="logo">
    <div class="logo-icon"><i class="fa-solid fa-heart"></i></div>
    <div class="logo-text">CareConnect</div>
  </div>
  
  <a href="nurse-dashboard.html" class="back-btn">
    <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
  </a>
</div>

<div class="container">
  <h1>Enter Patient Vitals</h1>
  <div class="subtitle">Update the current readings below</div>

  <div class="card">
    <form id="vitalsForm">
      <div class="form-grid">
        <div class="input-box bp">
          <label>Blood Pressure (mmHg)</label>
          <div class="dual">
            <input type="number" id="sys" placeholder="Systolic" required>
            <input type="number" id="dia" placeholder="Diastolic" required>
          </div>
        </div>
        <div class="input-box sugar">
          <label>Blood Sugar (mg/dL)</label>
          <input type="number" id="sugar" placeholder="e.g. 110" required>
        </div>
        <div class="input-box hr">
          <label>Heart Rate (bpm)</label>
          <input type="number" id="hr" placeholder="e.g. 72" required>
        </div>
        <div class="input-box spo2">
          <label>SpO₂ (%)</label>
          <input type="number" id="spo2" placeholder="e.g. 97" required>
        </div>
        <div class="input-box temp">
          <label>Temperature (°F)</label>
          <input type="number" id="temp" step="0.1" placeholder="e.g. 98.6" required>
        </div>
      </div>

      <div class="submit-area">
        <button type="submit" class="btn">
          <i class="fa-solid fa-upload"></i> Update Patient Record
        </button>
      </div>
    </form>
    <div class="note">⚠️ Existing values are pre-filled. Change them to update the record.</div>
  </div>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { doc, setDoc, serverTimestamp } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const params = new URLSearchParams(window.location.search);
const patientId = params.get("patientId");
const requestId = params.get("requestId");


if (!patientId) {
  alert("Patient ID missing");
}

// 1. Run this immediately when page loads to fill the inputs
window.onload = function() {
  const storedData = localStorage.getItem("patientVitals");
  
  if (storedData) {
    const data = JSON.parse(storedData);
    const inputs = data.input;

    // Fill the inputs with current values
    if(inputs) {
      document.getElementById("sys").value = inputs.systolic_bp || "";
      document.getElementById("dia").value = inputs.diastolic_bp || "";
      document.getElementById("sugar").value = inputs.blood_sugar || "";
      document.getElementById("hr").value = inputs.heart_rate || "";
      document.getElementById("spo2").value = inputs.oxygen_level || "";
      document.getElementById("temp").value = inputs.temperature || "";
    }
  }
};

// 2. Handle Form Submission (Update Logic)
document.getElementById("vitalsForm").addEventListener("submit", function(e){
  e.preventDefault();

  const rawData = {
    systolic_bp: parseInt(document.getElementById("sys").value),
    diastolic_bp: parseInt(document.getElementById("dia").value),
    blood_sugar: parseInt(document.getElementById("sugar").value),
    heart_rate: parseInt(document.getElementById("hr").value),
    oxygen_level: parseInt(document.getElementById("spo2").value),
    temperature: parseFloat(document.getElementById("temp").value),
    sleep_hours: 6
  };

  fetch("http://127.0.0.1:5000/calculate", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(rawData)
  })
  .then(res => res.json())
  .then(response => {
    if(response.status === "success") {
      onAuthStateChanged(auth, async (nurse) => {
  if (!nurse) {
    alert("Nurse not logged in");
    return;
  }

  const vitalsData = {
    bp: `${rawData.systolic_bp}/${rawData.diastolic_bp}`,
    sugar: rawData.blood_sugar,
    heartRate: rawData.heart_rate,
    spo2: rawData.oxygen_level,
    temperature: rawData.temperature,
    aiResult: response.data,
    updatedAt: serverTimestamp(),
    updatedBy: nurse.uid
  };

  await setDoc(
    doc(db, "users", patientId, "vitals", "latest"),
    vitalsData
  );

  alert("✅ Patient vitals updated successfully");
});

      const completeRecord = {
        input: rawData,
        ai_result: response.data
      };
      localStorage.setItem("patientVitals", JSON.stringify(completeRecord));
      alert("✅ Patient data updated successfully.");
    } else {
      alert("Error: " + response.message);
    }
  })
  .catch(err => {
    console.error(err);
    alert("Connection Error. Ensure backend is running.");
  });
});
</script>
</body>
</html>