<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CareConnect | Vitals Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    /* CSS Styles - Exact match to your design */
    :root { --blue-main: #0a73ff; --blue-soft: #eaf4ff; --white: #ffffff; --text-dark: #2b2b2b; --text-light: #6a6a6a; --alert: #ff7675; --safe: #2ecc71; --neutral: #95a5a6; }
    * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body { margin: 0; min-height: 100vh; background: var(--blue-soft); }
    .header { background: var(--white); padding: 18px 30px; display: flex; align-items: center; box-shadow: 0 8px 20px rgba(74,144,226,0.15); }
    .logo { display: flex; align-items: center; }
    .logo-icon { width: 42px; height: 42px; background: var(--blue-main); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 12px; }
    .logo-icon i { color: white; font-size: 20px; }
    .logo-text { font-size: 22px; font-weight: 600; color: var(--text-dark); }
    .container { max-width: 1100px; margin: auto; padding: 30px; }
    h1 { color: var(--blue-main); margin-bottom: 6px; }
    .subtitle { color: var(--text-light); font-size: 14px; margin-bottom: 30px; }
    .vitals-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .vital-card { background: var(--white); border-radius: 18px; padding: 20px; box-shadow: 0 20px 40px rgba(74,144,226,0.2); transition: 0.3s; }
    .vital-card:hover { transform: translateY(-4px); }
    .vital-header { display: flex; align-items: center; margin-bottom: 10px; }
    .vital-header i { font-size: 20px; color: var(--blue-main); margin-right: 10px; }
    .vital-name { font-size: 14px; color: var(--text-light); }
    .vital-value { font-size: 26px; font-weight: 600; color: var(--text-dark); }
    .vital-status { font-size: 13px; margin-top: 6px; font-weight: 600; }
    .safe { color: var(--safe); }
    .alert { color: var(--alert); }
    .pending { color: var(--neutral); } /* New style for empty state */
    .ai-box { background: linear-gradient(135deg, var(--blue-main), #3578c6); color: white; border-radius: 22px; padding: 26px; box-shadow: 0 25px 50px rgba(74,144,226,0.35); }
    .ai-header { display: flex; align-items: center; margin-bottom: 12px; }
    .ai-header i { font-size: 22px; margin-right: 10px; }
    .ai-header h2 { font-size: 18px; margin: 0; }
    .ai-box p { font-size: 14px; line-height: 1.6; opacity: 0.95; }
    .ai-warning { margin-top: 12px; background: rgba(255,255,255,0.15); padding: 12px; border-radius: 14px; font-size: 14px; }
  </style>
</head>

<body>

<div class="header">
  <div class="logo">
    <div class="logo-icon"><i class="fa-solid fa-heart"></i></div>
    <div class="logo-text">CareConnect</div>
  </div>
</div>

<div class="container">
  <h1>Patient Vitals</h1>
  <div class="subtitle">Live health data monitored by CareConnect AI</div>

  <div class="vitals-grid">

    <div class="vital-card">
      <div class="vital-header">
        <i class="fa-solid fa-heart-pulse"></i>
        <div class="vital-name">Heart Rate</div>
      </div>
      <div class="vital-value" id="disp-hr">-- bpm</div>
      <div class="vital-status pending" id="stat-hr">Waiting...</div>
    </div>

    <div class="vital-card">
      <div class="vital-header">
        <i class="fa-solid fa-stethoscope"></i>
        <div class="vital-name">Blood Pressure</div>
      </div>
      <div class="vital-value" id="disp-bp">-- / --</div>
      <div class="vital-status pending" id="stat-bp">Waiting...</div>
    </div>

    <div class="vital-card">
      <div class="vital-header">
        <i class="fa-solid fa-droplet"></i>
        <div class="vital-name">Blood Sugar</div>
      </div>
      <div class="vital-value"><span id="disp-sugar">--</span> mg/dL</div>
      <div class="vital-status pending" id="stat-sugar">Waiting...</div>
    </div>

    <div class="vital-card">
      <div class="vital-header">
        <i class="fa-solid fa-lungs"></i>
        <div class="vital-name">SpO₂</div>
      </div>
      <div class="vital-value"><span id="disp-spo2">--</span>%</div>
      <div class="vital-status pending" id="stat-spo2">Waiting...</div>
    </div>

  </div>

  <div class="ai-box">
    <div class="ai-header">
      <i class="fa-solid fa-brain"></i>
      <h2>AI Health Insights</h2>
    </div>

    <p id="ai-main-text">
      No recent vitals found. Waiting for nurse update...
    </p>

    <div class="ai-warning" id="ai-alert-box" style="display:none;">
      ⚠️ <b>Analysis:</b> <span id="ai-reasons"></span>
    </div>
  </div>

</div>

<script type="module">
  import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { doc, onSnapshot } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  window.onload = function() {
    // 1. Check for data sent from the Nurse Page
    onAuthStateChanged(auth, (user) => {
  if (!user) {
    alert("Please login");
    location.href = "login.html";
    return;
  }

  const vitalsRef = doc(db, "users", user.uid, "vitals", "latest");

  onSnapshot(vitalsRef, (snap) => {
    if (!snap.exists()) {
      console.log("No vitals yet");
      return;
    }

    const v = snap.data();

    // Display values
    document.getElementById("disp-hr").textContent = v.heartRate + " bpm";
    document.getElementById("disp-bp").textContent = v.bp;
    document.getElementById("disp-sugar").textContent = v.sugar;
    document.getElementById("disp-spo2").textContent = v.spo2;

    // Status coloring
    updateStatus("stat-hr", v.heartRate > 100 || v.heartRate < 50);
    updateStatus("stat-bp", parseInt(v.bp.split("/")[0]) >= 140);
    updateStatus("stat-sugar", v.sugar > 200 || v.sugar < 70);
    updateStatus("stat-spo2", v.spo2 < 95);

    // AI section
    document.getElementById("ai-main-text").innerHTML =
      `AI Risk Score: <b>${v.aiResult.risk_score}/100</b>
       (${v.aiResult.risk_label})`;

    document.getElementById("ai-alert-box").style.display = "block";

    if (
      v.aiResult.reasons.length &&
      v.aiResult.reasons[0] !== "Vitals within normal limits"
    ) {
      document.getElementById("ai-reasons").textContent =
        v.aiResult.reasons.join(", ");
    } else {
      document.getElementById("ai-alert-box").style.background =
        "rgba(46, 204, 113, 0.2)";
      document.getElementById("ai-reasons").textContent =
        "Vitals are stable. No risks detected.";
    }
  });
});

    // If NO data exists, the page stays with "--" and "Waiting..."
  };

  // Helper function to color code the status text
  function updateStatus(elementId, isDanger) {
    const el = document.getElementById(elementId);
    if(isDanger) {
      el.textContent = "Abnormal";
      el.className = "vital-status alert";
    } else {
      el.textContent = "Normal";
      el.className = "vital-status safe";
    }
  }
</script>

</body>
</html>